/*
 |--------------------------------------------------------------------------
 | SkyCaiji (蓝天采集器)
 |--------------------------------------------------------------------------
 | Copyright (c) 2018 http://www.skycaiji.com All rights reserved.
 |--------------------------------------------------------------------------
 | 使用协议  http://www.skycaiji.com/licenses
 |--------------------------------------------------------------------------
 */
'use strict';function CollectorPattern(formid){this.formid='#'+formid;this.processForm='';this.processBox=''}
CollectorPattern.prototype={constructor:CollectorPattern,init:function(){var $_o=this;$($_o.formid+' .coll-tab a[data-toggle="tab"]').on('shown.bs.tab',function(e){var activeTab=$(e.target).attr('href');$($_o.formid+' [name="tab_link"]').val(activeTab.replace(/^#+/,''))});$($_o.formid+' select[name="config[charset]"]').bind('change',function(){if($(this).val()=='custom'){$($_o.formid+' input[name="config[charset_custom]"]').show()}else{$($_o.formid+' input[name="config[charset_custom]"]').hide()}});$($_o.formid+' #coll_pattern_request_headers .dm-useragent li a').bind('click',function(){$($_o.formid+' [name="config[request_headers][useragent]"]').val($(this).attr('data-useragent'))});$(this.formid).on('click','[name="config[request_headers][open]"]',function(){if($(this).val()==1){$('#c_p_request_headers_open').show()}else{$('#c_p_request_headers_open').hide()}});$($_o.formid+' #coll_pattern_request_headers .add-request-header').bind('click',function(){$_o.add_request_header('','')});$($_o.formid+' .c-p-request-headers').on('click','.delete-request-header',function(){$(this).parents('tr').eq(0).remove()});$(this.formid+' #coll_pattern_source .glyphicon-plus').bind('click',function(){windowModal('添加起始网址',ulink("Cpattern/source"))});$(this.formid+' #coll_pattern_source .glyphicon-trash').bind('click',function(){$_o.source_op('clear_all')});$(this.formid+' #coll_pattern_source').on('click','.glyphicon-edit',function(){var urlTxt=$(this).parents('.input-group').find('input[name="config[source_url][]"]').val();urlTxt=urlTxt?urlTxt:'';var url=ulink("Cpattern/source");var urlId=$(this).parents('.input-group').find('input[name="config[source_url][]"]').attr('id');urlId=urlId?urlId:'';if(urlTxt||urlId){url=ulink("Cpattern/source?url=_url_&uid=_uid_");url=url.replace('_url_',encodeURIComponent(url_base64encode(urlTxt)));url=url.replace('_uid_',urlId)}
windowModal('添加起始网址',url)});$(this.formid+' #coll_pattern_source').on('click','.glyphicon-remove',function(){var obj=$(this);confirmRight(window.tpl_lang.confirm_delete,function(){obj.parents('.form-group').eq(0).remove()})});eleExchange(this.formid+' #coll_pattern_source','.glyphicon-arrow-up','.glyphicon-arrow-down','.form-group');$(this.formid).find('input[name="config[source_url][]"]').eq(0).attr('id',generateUUID());$('#coll_tab a[href="#coll_pattern_link"]').bind('click',function(){if($($_o.formid+' [name="config[source_is_url]"]').is(':checked')){toastr.warning('起始页网址已设置为内容页网址！');$('#panel_coll_pattern_level_url').hide();$('#panel_coll_pattern_cont_url').hide()}else{$('#panel_coll_pattern_level_url').show();$('#panel_coll_pattern_cont_url').show()}});$($_o.formid+' #coll_pattern_level_url .add-level-url').bind('click',function(){var url=ulink("Cpattern/level_url");windowModal('添加多级网址规则',url)});$($_o.formid+' #c_p_level_urls').on('click','.name',function(){var parent=$(this).parents('[id^="level_url_"]').eq(0);var objid=parent.attr('id');var level_url=parent.find('[name="config[level_urls][]"]').val();var url=ulink("Cpattern/level_url?objid=_objid_&level_url=_val_",{_objid_:objid,_val_:level_url});windowModal('编辑多级网址规则',url)});$($_o.formid+' #c_p_level_urls').on('click','.delete',function(){var curObj=$(this);confirmRight('确定删除？',function(){curObj.parents('[id^="level_url_"]').eq(0).remove()})});eleExchange($_o.formid+' #c_p_level_urls','.glyphicon-arrow-up','.glyphicon-arrow-down','tr');$($_o.formid+' #coll_pattern_relation_url .add-relation-url').bind('click',function(){var url=ulink("Cpattern/relation_url");windowModal('添加关联页网址规则',url)});$($_o.formid+' #c_p_relation_urls').on('click','.name',function(){var parent=$(this).parents('[id^="relation_url_"]').eq(0);var objid=parent.attr('id');var relation_url=parent.find('[name="config[relation_urls][]"]').val();var url=ulink("Cpattern/relation_url?objid=_objid_&relation_url=_val_",{_objid_:objid,_val_:relation_url});windowModal('编辑关联页网址规则',url)});$($_o.formid+' #c_p_relation_urls').on('click','.delete',function(){var curObj=$(this);confirmRight('确定删除？',function(){curObj.parents('[id^="relation_url_"]').eq(0).remove()})});eleExchange($_o.formid+' #c_p_relation_urls','.glyphicon-arrow-up','.glyphicon-arrow-down','tr');$(this.formid+' #coll_pattern_field').on('click','.add-field,.field-name',function(){var url=ulink("Cpattern/field?field=_field_&objid=_objid_");var field=null;var objid=$(this).parents('tr[id^="field_"]').eq(0).attr('id');var title='添加字段';if(objid){field=$('#'+objid).find('input[name="config[field_list][]"]').val();title='编辑字段'}
url=url.replace('_field_',field?encodeURIComponent(field):'');url=url.replace('_objid_',objid?encodeURIComponent(objid):'');windowModal(title,url)});$(this.formid+' #coll_pattern_field').on('click','.field-del',function(){var obj=$(this);confirmRight(window.tpl_lang.confirm_delete,function(){obj.parents('tr').eq(0).remove()})});$(this.formid+' #coll_pattern_field').on('click','.field-process',function(){var url=ulink("Cpattern/process");var process=$(this).siblings('input[name="config[field_process][]"]').val();var objid=$(this).parents('tr[id^="field_"]').eq(0).attr('id');windowModal('数据处理',url,{ajax:{method:'post',data:{objid:objid,process:process}}})});$(this.formid+' #coll_pattern_process').on('click','.add-process',function(){var url=ulink("Cpattern/process?type=common");windowModal('数据处理（通用）',url)});$(this.formid).on('click','[name="config[paging][open]"]',function(){if($(this).val()==1){$('#c_p_paging_open').show()}else{$('#c_p_paging_open').hide()}});$(this.formid+' #coll_pattern_paging').on('click','.add-paging-field',function(){var url=ulink("Cpattern/paging_field");windowModal('分页内容字段',url)});$(this.formid+' #c_p_paging_fields').on('click','.field',function(){var parent=$(this).parents('.paging-field').eq(0);var objid=parent.attr('id');var pagingField=parent.find('[name="config[paging_fields][]"]').val();var url=ulink("Cpattern/paging_field?objid=_objid_&paging_field=_pfield_",{_objid_:objid,_pfield_:pagingField});windowModal('分页内容字段',url)});$(this.formid+' #c_p_paging_fields').on('click','.delete',function(){$(this).parents('.paging-field').eq(0).remove()});eleExchange(this.formid+' #coll_pattern_field','.glyphicon-arrow-up','.glyphicon-arrow-down','tr[id^="field_"]');$(this.formid+' [name="effective"]').val(1)},load:function(config){var $_o=this;if(config){$(this.formid+' [name="config[charset]"]').val(config.charset).trigger('change');$(this.formid+' [name="config[charset_custom]"]').val(config.charset_custom);$(this.formid+' [name="config[url_complete]"][value="'+parseInt(config.url_complete)+'"]').prop('checked','checked');if(config.request_headers){var r_h_params=new Array('useragent','cookie','referer');for(var i in r_h_params){$(this.formid+' [name="config[request_headers]['+r_h_params[i]+']"]').val(config.request_headers[r_h_params[i]])}
if(config.request_headers.custom_names){var r_h_vals=config.request_headers.custom_vals?config.request_headers.custom_vals:{};for(var i in config.request_headers.custom_names){$_o.add_request_header(config.request_headers.custom_names[i],r_h_vals[i])}}
if(config.request_headers.open){$(this.formid+' [name="config[request_headers][open]"][value="'+parseInt(config.request_headers.open)+'"]').trigger('click');if(parseInt(config.request_headers.open)>0){$('#coll_pattern_request_headers').addClass('in')}}}
if(config.source_url){for(var i in config.source_url){this.source_op('add',{url:config.source_url[i]})}}
$(this.formid+' [name="config[source_is_url]"]').attr('checked',config.source_is_url?true:!1);if(config.area_start||config.area_end){$(this.formid+' [name="config[area_start]"]').val(config.area_start);$(this.formid+' [name="config[area_end]"]').val(config.area_end);$('#coll_pattern_link_area').addClass('in').attr('aria-expanded',!0).attr('style','')}
if(config.url_rule||config.url_merge){$(this.formid+' [name="config[url_rule]"]').val(config.url_rule);$(this.formid+' [name="config[url_merge]"]').val(config.url_merge);$('#coll_pattern_link_match').addClass('in').attr('aria-expanded',!0).attr('style','')}
if(config.url_must||config.url_ban){$(this.formid+' [name="config[url_must]"]').val(config.url_must);$(this.formid+' [name="config[url_ban]"]').val(config.url_ban);$('#coll_pattern_link_filter').addClass('in').attr('aria-expanded',!0).attr('style','')}
if(config.level_urls){for(var i in config.level_urls){$_o.level_url_op('add',{level_url:config.level_urls[i]})}
$('#coll_pattern_level_url').addClass('in').attr('aria-expanded',!0).attr('style','')}
if(config.relation_urls){for(var i in config.relation_urls){$_o.relation_url_op('add',{relation_url:config.relation_urls[i]})}
$('#coll_pattern_relation_url').addClass('in').attr('aria-expanded',!0).attr('style','')}
if(config.field_list&&config.field_list.length>0){this.field_op('clearall');for(var i in config.field_list){var fieldProcess=null;if(config.field_process){fieldProcess=config.field_process[i]}
this.field_op('add',{field:config.field_list[i],process:fieldProcess})}}
if(config.common_process){$('#coll_pattern_process').addClass('in').attr('aria-expanded',!0).attr('style','');$.ajax({type:'post',url:ulink("Cpattern/process?type=common&op=load"),data:{process:config.common_process},dataType:'html',success:function(data){$('body').append(data)}})}
if(config.paging){for(var i in config.paging){var curEle=$(this.formid+' [name="config[paging]['+i+']"]');if(curEle.is('input:text')||curEle.is('textarea')){curEle.val(config.paging[i])}}
$(this.formid+' [name="config[paging][max]"]').val(parseInt(config.paging.max));if(config.paging.open){$(this.formid+' [name="config[paging][open]"][value="'+parseInt(config.paging.open)+'"]').trigger('click');if(parseInt(config.paging.open)>0){$('#coll_pattern_paging').addClass('in')}}}
if(config.paging_fields){for(var i in config.paging_fields){$_o.paging_field_op('add',{paging_field:config.paging_fields[i]})}}}
$(document).ready(function(){var tab_link_val=$($_o.formid+' [name="tab_link"]').val();if(tab_link_val){tab_link_val='#'+tab_link_val.replace(/^#+/,'');$($_o.formid+' .coll-tab a[data-toggle="tab"]').each(function(){if(tab_link_val==$(this).attr('href')){$(this).tab('show');return}})}})},source_op:function(op,params){var $_o=this;params=params?params:{};var formObj=params.formObj?params.formObj:'#form_source';if(op=='init'){$(formObj).find('.nav-tabs li a').bind('click',function(){$(formObj).find('input[name="source[type]"]').val($(this).attr('source-type'))});$(formObj).find('div[source-param]').find('input,textarea').bind('change',function(){if($(this).attr("type")=='radio'){return!1}
$(this).parents('div[source-param]').find('input[name="source[param]"]').prop('checked',!0)});if(params.source){$(formObj+' .nav-tabs').find('a[source-type="'+params.source.type+'"]').click();if(params.source.type=='custom'){$(formObj+' textarea[name="source[urls]"]').val(params.source.urls)}else if(params.source.type=='batch'){$(formObj+' input[name="source[url]"]').val(params.source.url);var param_type=params.source.param;if(param_type=='num'){$(formObj+' input[name="source[param_num_start]"]').val(params.source.param_num_start);$(formObj+' input[name="source[param_num_end]"]').val(params.source.param_num_end);$(formObj+' input[name="source[param_num_inc]"]').val(params.source.param_num_inc);$(formObj+' input[name="source[param_num_desc]"]').attr('checked',params.source.param_num_desc?'checked':'')}else if(param_type=='letter'){$(formObj+' input[name="source[param_letter_start]"]').val(params.source.param_letter_start);$(formObj+' input[name="source[param_letter_end]"]').val(params.source.param_letter_end);$(formObj+' input[name="source[param_letter_desc]"]').attr('checked',params.source.param_letter_desc?'checked':'')}else if(param_type=='custom'){$(formObj+' textarea[name="source[param_custom]"]').val(params.source.param_custom)}
$(formObj+' input[name="source[param]"][value="'+param_type+'"]').attr('checked','checked')}}}else if(op=='add'){this.source_op('clear_null');var html='<div class="form-group"><div class="input-group">'+'<input type="text" class="form-control" name="config[source_url][]" id="url_'+generateUUID()+'" value="'+params.url+'">'+'<div class="input-group-addon brl_0"><a class="glyphicon glyphicon-edit"></a></div>'+'<div class="input-group-addon brl_0"><a class="glyphicon glyphicon-remove"></a></div>'+'<div class="input-group-addon"><a href="javascript:;" class="glyphicon glyphicon-arrow-up"></a> <a href="javascript:;" class="glyphicon glyphicon-arrow-down"></a></div></div></div>';$($_o.formid+' #coll_pattern_source .c-p-source-urls').append(html)}else if(op=='add_sub'){$.ajax({type:'POST',dataType:'json',url:$(formObj).attr('action'),data:$(formObj).serialize(),success:function(data){if(data.status==1){var source_type=$(formObj).find('input[name="source[type]"]').val();if(source_type=='custom'){$('#myModal').modal('hide');var urls=data.info.urls;var ix=0;for(var i in urls){ix++;if(ix==1){if(data.info.uid){$('#'+data.info.uid).val(urls[i]);continue}}
$_o.source_op('add',{'url':urls[i]})}}else if(source_type=='batch'){if(params.preview==1){var urls=data.info.urls;var txt='';for(var i in urls){txt+=urls[i]+"\r\n"}
$(formObj).find('#source_preview').val(txt)}else{if(data.info.uid){$('#'+data.info.uid).val(data.info.url)}else{$_o.source_op('add',{'url':data.info.url})}
$('#myModal').modal('hide')}}}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}else if(op=='clear_null'){$($_o.formid+' #coll_pattern_source').find('input[name="config[source_url][]"]').each(function(){if(!$(this).val()){$(this).parents('.form-group').eq(0).remove()}})}else if(op=='clear_all'){confirmRight('是否清空网址？',function(){$($_o.formid+' #coll_pattern_source').find('input[name="config[source_url][]"]').each(function(){$(this).parents('.form-group').eq(0).remove()})})}},field_op:function(op,params){var $_o=this;params=params?params:{};var formObj=params.formObj?params.formObj:'#form_field';if(op=='init'){var level_urls=new Array();$('#c_p_level_urls [id^="level_url_"]').each(function(){var levelName=$(this).find('.name').text();level_urls.push('<option value="level_url:'+levelName+'">'+levelName+'</option>')});if(($($_o.formid+' [name="config[source_is_url]"]').is(':checked')!=!0)&&level_urls.length>0){$(formObj+' select[name="field[source]"]').append('<optgroup label="多级页">'+level_urls.join('')+'</optgroup>')}
var relation_urls=new Array();$('#c_p_relation_urls [id^="relation_url_"]').each(function(){var relationName=$(this).find('.name').text();relation_urls.push('<option value="relation_url:'+relationName+'">'+relationName+'</option>')});if(relation_urls.length>0){$(formObj+' select[name="field[source]"]').append('<optgroup label="关联页">'+relation_urls.join('')+'</optgroup>')}
$(formObj+' select[name="field[module]"]').bind('change',function(){$(formObj+' .c-p-field-module').hide();$(formObj+' .c-p-field-module[module="'+$(this).val()+'"]').show();var source_module=new Array('rule','xpath','json','auto');var in_module=!1;for(var i in source_module){if($(this).val()==source_module[i]){in_module=!0;break}}
if(in_module){$(formObj+' .c-p-field-source').show()}else{$(formObj+' select[name="field[source]"]').val('');$(formObj+' .c-p-field-source').hide()}});$(formObj+' select[name="field[xpath_attr]"]').bind('change',function(){if($(this).val()=='custom'){$(formObj+' [name="field[xpath_attr_custom]"]').show()}else{$(formObj+' [name="field[xpath_attr_custom]"]').hide()}});$(formObj+' select[name="field[json_arr]"]').bind('change',function(){if($(this).val()=='implode'){$(formObj+' [name="field[json_arr_implode]"]').show()}else{$(formObj+' [name="field[json_arr_implode]"]').hide()}});$(formObj+' select[name="field[extract_module]"]').bind('change',function(){$('.c-p-field-extract-module').hide();$('.c-p-field-extract-module[extract-module="'+$(this).val()+'"]').show()});$(formObj+' select[name="field[extract_json_arr]"]').bind('change',function(){if($(this).val()=='implode'){$(formObj+' [name="field[extract_json_arr_implode]"]').show()}else{$(formObj+' [name="field[extract_json_arr_implode]"]').hide()}});$(formObj+' select[name="field[extract_xpath_attr]"]').bind('change',function(){if($(this).val()=='custom'){$(formObj+' [name="field[extract_xpath_attr_custom]"]').show()}else{$(formObj+' [name="field[extract_xpath_attr_custom]"]').hide()}});var fieldList=$_o.get_fields();for(var i in fieldList){if(params.field&&params.field.name==fieldList[i]){continue}
$(formObj+' #c_p_field_merge_list').append('<a href="javascript:;" style="margin-right:10px;">[字段:'+fieldList[i]+']</a>');$(formObj+' [name="field[extract]"]').append('<option>'+fieldList[i]+'</option>')}
$(formObj+' #c_p_field_time_format_list').on('click','a',function(){$(formObj+' [name="field[time_format]"]').insertAtCaret($(this).text())});$(formObj+' #c_p_field_merge_list').on('click','a',function(){$(formObj+' [name="field[merge]"]').insertAtCaret($(this).text())});$(formObj+' [name="field[rule_multi]"]').on('change',function(){if($(this).is(':checked')){$('#c_p_field_rule_multi_str').show()}else{$('#c_p_field_rule_multi_str').hide()}});$(formObj+' [name="field[xpath_multi]"]').on('change',function(){if($(this).is(':checked')){$('#c_p_field_xpath_multi_str').show()}else{$('#c_p_field_xpath_multi_str').hide()}});$(formObj+' [name="field[page_rule_multi]"]').on('change',function(){if($(this).is(':checked')){$('#c_p_field_page_rule_multi_str').show()}else{$('#c_p_field_page_rule_multi_str').hide()}});$(formObj+' input[name="field[time_start]"],#form_field input[name="field[time_end]"]').datetimepicker({lang:'ch'});$(formObj+' select[name="field[time_format]"]').html();$(formObj).bind('submit',function(){$_o.field_op('add_sub');return!1});if(params.field){for(var i in params.field){var fieldEle=$(formObj+' [name="field['+i+']"]');if(fieldEle.is('input:text')){fieldEle.val(params.field[i])}else if(fieldEle.is('select')){fieldEle.val(params.field[i]).trigger("change")}}
$(formObj+' [name="field[rule_multi]"]').trigger("change");$(formObj+' [name="field[page_rule_multi]"]').trigger("change");$(formObj+' [name="field[xpath_multi]"]').trigger("change");$(formObj+' [name="field[auto]"][value="'+params.field.auto+'"]').prop('checked',!0)}}else if(op=='add'){var fieldSource='默认页';if(params.field.source){if('source_url'==params.field.source){fieldSource='起始页'}else if(params.field.source.indexOf('level_url:')>-1){fieldSource='多级页：'+params.field.source.replace('level_url:','')}else if(params.field.source.indexOf('relation_url:')>-1){fieldSource='关联页：'+params.field.source.replace('relation_url:','')}}
if(params.objid){var eleObj=$($_o.formid+' #'+params.objid);eleObj.find('.field-name').html(params.field.name);eleObj.find('.field-source').html(fieldSource);eleObj.find('.field-module').html(window.tpl_lang['field_module_'+params.field.module]);eleObj.find('input[name="config[field_list][]"]').val(url_base64encode(JSON.stringify(params.field)))}else{var html='<tr id="field_'+generateUUID()+'">'+'<td class="field-name">'+params.field.name+'</td>'+'<td class="field-source">'+fieldSource+'</td>'+'<td class="field-module">'+window.tpl_lang['field_module_'+params.field.module]+'</td>'+'<td>'+'<input type="hidden" name="config[field_list][]" value="'+url_base64encode(JSON.stringify(params.field))+'" />'+'<input type="hidden" name="config[field_process][]" value="'+(params.process?url_base64encode(JSON.stringify(params.process)):'')+'" />'+'<a href="javascript:;" class="field-process'+(params.process?' exist-process':'')+'">数据处理</a>'+'&nbsp; <a href="javascript:;" class="field-del">删除</a>'+'&nbsp; <a href="javascript:;" class="glyphicon glyphicon-arrow-up"></a>'+'&nbsp;<a href="javascript:;" class="glyphicon glyphicon-arrow-down"></a>'+'</td>'+'</tr>';$($_o.formid+' #coll_pattern_field .c-p-field-list').append(html)}}else if(op=='add_sub'){var objid=$(formObj+' input[name="objid"]').val();var checkName=!0;if(objid){var fname=$($_o.formid+' #'+objid).find('.field-name').text();if(fname==$(formObj+' input[name="field[name]"]').val()){checkName=!1}}
if(checkName){var hasName=!1;var fieldList=$_o.get_fields();for(var i in fieldList){if($(formObj+' input[name="field[name]"]').val()==fieldList[i]){hasName=!0;break}}
if(hasName){toastr.error('字段名称已存在！');return!1}}
$.ajax({type:'POST',dataType:'json',url:$(formObj).attr('action'),data:$(formObj).serialize(),success:function(data){if(data.status==1){$('#myModal').modal('hide');$_o.field_op('add',data.info)}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}else if(op=='clearall'){$($_o.formid+' #coll_pattern_field .c-p-field-list tbody').html('')}},process_op:function(op,params){var $_o=this;params=params?params:{};var defaultForm='#form_process';if(op=='init'){$_o.processForm=params.formObj?params.formObj:defaultForm;$_o.processBox=params.boxObj?params.boxObj:'#window_process';if($($_o.processForm).is('form')){$($_o.processForm).bind('submit',function(){$_o.process_op('add_sub');return!1})}
$($_o.processBox+' .process-add').bind('click',function(){var module=$($_o.processBox+' select[name="process[module]"]').val();$_o.process_op('add',{'add_new':1,'module':module})});if($($_o.processForm).prop('inited')==1){return!0}
$($_o.processForm).on('click','.p-m-html-tags a',function(){var tag=$(this).find('span').text();var moduleHtml=$(this).parents('.p-m-html-tags').eq(0).attr('module-html');var tagsObj=$(this).parents('section').eq(0).find('input[data-process="html:'+moduleHtml+'"]');var tags=tagsObj.val()+','+tag;tags=tags.replace(/(^,+)|(,+$)/,'');tagsObj.val(tags)});$($_o.processForm).on('click','.sign-wildcard',function(){var toObj=$(this).parent().siblings('[data-process="replace:replace_from"]');cpWildcard(toObj)});eleExchange($_o.processForm+' .c-p-process-accordion','.glyphicon-arrow-up','.glyphicon-arrow-down','.panel');if(params.process){for(var i in params.process){if(params.process[i]){$_o.process_op('add',params.process[i])}}}
$($_o.processForm).prop('inited',1)}else if(op=='add'){if(!params.module){toastr.error('请选择处理方式');return!1}
var parentid=$($_o.processForm+' .c-p-process-accordion').attr('id');if(!parentid){parentid='p_accordion_'+generateUUID();$($_o.processForm+' .c-p-process-accordion').attr('id',parentid)}
var dataParent=parentid?('data-parent="#'+parentid+'"'):'';var moduleHtml=$($_o.processBox+' .c-p-process-module[module="'+params.module+'"]').html();if(params.module=='html'){moduleHtml=moduleHtml.replace(/p_m_html_allow/ig,'p_m_html_allow_'+generateUUID());moduleHtml=moduleHtml.replace(/p_m_html_filter/ig,'p_m_html_filter_'+generateUUID())}
var processName='process[i_'+generateUUID()+']';moduleHtml='<input type="hidden" name="'+processName+'[module]" value="'+params.module+'" />'+moduleHtml;var collapseId='p_collapse_'+generateUUID();var html='<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" '+dataParent+' href="#'+collapseId+'">'+window.tpl_lang['process_module_'+params.module]+'</a> <div style="float:right;font-size:14px;"><a href="javascript:;" class="glyphicon glyphicon-arrow-up"></a> <a href="javascript:;" class="glyphicon glyphicon-arrow-down"></a> <a href="javascript:;" class="glyphicon glyphicon-remove" onclick="c_pattern.process_op(\'delete\',{obj:this})"></a></div></h4></div>'+'<div id="'+collapseId+'" class="panel-collapse collapse '+(params.add_new?' in ':'')+'"><div class="panel-body">'+moduleHtml+'</div></div></div>';$($_o.processForm+' .c-p-process-accordion').append(html);$($_o.processForm).show();if(params.module=='html'){$($_o.processForm+' #'+collapseId).find('[data-process="html:html_allow"]').attr('name',processName+'[html_allow]').val(params.html_allow?params.html_allow:'');$($_o.processForm+' #'+collapseId).find('[data-process="html:html_filter"]').attr('name',processName+'[html_filter]').val(params.html_filter?params.html_filter:'');if(params.html_filter){$($_o.processForm+' #'+collapseId).find('a[href^="#p_m_html_filter"]').tab('show')}}else if(params.module=='replace'){$($_o.processForm+' #'+collapseId).find('[data-process="replace:replace_from"]').attr('name',processName+'[replace_from]').val(params.replace_from?params.replace_from:'');$($_o.processForm+' #'+collapseId).find('[data-process="replace:replace_to"]').attr('name',processName+'[replace_to]').val(params.replace_to?params.replace_to:'')}else if(params.module=='filter'){$($_o.processForm+' #'+collapseId).find('[data-process="filter:filter_list"]').attr('name',processName+'[filter_list]').val(params.filter_list?params.filter_list:'');$($_o.processForm+' #'+collapseId).find('[data-process="filter:filter_replace"]').attr('name',processName+'[filter_replace]').val(params.filter_replace?params.filter_replace:'');$($_o.processForm+' #'+collapseId).find('[data-process="filter:filter_pass"]').attr('name',processName+'[filter_pass]').prop('checked',params.filter_pass?true:!1)}else if(params.module=='tool'){$($_o.processForm+' #'+collapseId).find('[data-process="tool:tool_list"]').attr('name',processName+'[tool_list][]');if(params.tool_list){for(var ti in params.tool_list){$($_o.processForm+' #'+collapseId).find('[data-process="tool:tool_list"][value="'+params.tool_list[ti]+'"]').prop('checked',!0)}}}
if($_o.processForm!=defaultForm){$('#myModal').modal('hide')}}else if(op=='add_sub'){$.ajax({type:'POST',dataType:'json',url:$($_o.processForm).attr('action'),data:$($_o.processForm).serialize(),success:function(data){if(data.status==1){$('#myModal').modal('hide');if(data.info&&data.info.objid){$($_o.formid+' #'+data.info.objid).find('input[name="config[field_process][]"]').val(data.info.process_json?url_base64encode(data.info.process_json):'');if(data.info.process_json){$($_o.formid+' #'+data.info.objid).find('.field-process').addClass('exist-process')}else{$($_o.formid+' #'+data.info.objid).find('.field-process').removeClass('exist-process')}}}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}else if(op=='delete'){confirmRight('是否删除',function(){$(params.obj).parents('.panel').eq(0).remove()})}},paging_field_op:function(op,params){var $_o=this;params=params?params:{};var formObj=params.formObj?params.formObj:'#form_paging_field';if(op=='init'){var fieldList=$_o.get_fields();var fieldOptions='<option value="">请选择</option>';for(var i in fieldList){fieldOptions+='<option value="'+fieldList[i]+'">'+fieldList[i]+'</option>'}
$(formObj+' select[name="paging_field[field]"]').html(fieldOptions);$(formObj).bind('submit',function(){$_o.paging_field_op('add_sub');return!1});if(params.paging_field){$(formObj+' select[name="paging_field[field]"]').val(params.paging_field.field);$(formObj+' [name="paging_field[delimiter]"]').val(params.paging_field.delimiter)}}else if(op=='add'){params.paging_field=params.paging_field?params.paging_field:{};var tpl='<a href="javascript:;" class="field">__field__</a><em class="glyphicon glyphicon-remove-circle delete"></em><input type="hidden" name="config[paging_fields][]" value="__paging_field__" />';tpl=tpl.replace(/__field__/ig,params.paging_field.field).replace(/__paging_field__/ig,url_base64encode(JSON.stringify(params.paging_field)));var objid=params.objid;if(!objid){objid='paging_field_'+generateUUID();$('#c_p_paging_fields').append('<div class="param-label paging-field" id="'+objid+'"></div>')}
$('#'+objid).html(tpl)}else if(op=='add_sub'){var objid=$(formObj+' input[name="objid"]').val();var checkField=!0;if(objid){var field=$($_o.formid+' #'+objid).find('.field').text();if(field==$(formObj+' select[name="paging_field[field]"]').val()){checkField=!1}}
if(checkField){var hasField=!1;var fieldList=new Array();$('#c_p_paging_fields .paging-field .field').each(function(){fieldList.push($(this).text())});for(var i in fieldList){if($(formObj+' select[name="paging_field[field]"]').val()==fieldList[i]){hasField=!0;break}}
if(hasField){toastr.error('该字段已存在！');return!1}}
$.ajax({type:'POST',dataType:'json',url:$(formObj).attr('action'),data:$(formObj).serialize(),success:function(data){if(data.status==1){$('#myModal').modal('hide');$_o.paging_field_op('add',data.info)}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}},add_default_fields:function(){var $_o=this;confirmRight('添加默认字段会清除当前字段列表，是否继续？',function(){$_o.field_op('clearall');var defFields=new Array({"name":"标题","module":"auto","auto":"title"},{"name":"正文","module":"auto","auto":"content"},{"name":"keywords","module":"auto","auto":"keywords"},{"name":"description","module":"auto","auto":"description"});for(var i in defFields){$_o.field_op('add',{field:defFields[i]})}})},add_request_header:function(name,val){name=name?name:'';val=val?val:'';var $_o=this;var tr='<tr><td><input type="text" name="config[request_headers][custom_names][]" value="'+name+'" class="form-control" /></td>'+'<td><input type="text" name="config[request_headers][custom_vals][]" class="form-control" value="'+val+'" /></td>'+'<td><a href="javascript:;" class="glyphicon glyphicon-remove delete-request-header"></a></td></tr>';$($_o.formid+' #coll_pattern_request_headers table.c-p-request-headers tbody').append(tr)},get_fields:function(){var fields=new Array();$(this.formid+' #coll_pattern_field .c-p-field-list').find('.field-name').each(function(){var fieldName=$(this).text();if(fieldName){fields.push(fieldName)}});return fields},level_url_op:function(op,params){var $_o=this;params=params?params:{};var formObj=params.formObj?params.formObj:'#form_level_url';if(op=='init'){$(formObj).bind('submit',function(){$_o.level_url_op('add_sub');return!1});if(params.level_url){for(var i in params.level_url){$(formObj+' [name="level_url['+i+']"]').val(params.level_url[i])}}}else if(op=='add'){if(params.objid){var eleObj=$($_o.formid+' #'+params.objid);eleObj.find('.name').html(params.level_url.name);eleObj.find('input[name="config[level_urls][]"]').val(url_base64encode(JSON.stringify(params.level_url)))}else{var html='<tr id="level_url_'+generateUUID()+'">'+'<td>第<span class="level">级</span></td>'+'<td><a href="javascript:;" class="name">'+params.level_url.name+'</a></td>'+'<td>'+'<input type="hidden" name="config[level_urls][]" value="'+url_base64encode(JSON.stringify(params.level_url))+'" />'+'<a href="javascript:;" class="delete">删除</a>'+'&nbsp; <a href="javascript:;" class="glyphicon glyphicon-arrow-up"></a>'+'&nbsp;<a href="javascript:;" class="glyphicon glyphicon-arrow-down"></a>'+'</td>'+'</tr>';$($_o.formid+' #c_p_level_urls').append(html)}}else if(op=='add_sub'){var objid=$(formObj+' input[name="objid"]').val();var checkName=!0;if(objid){var name=$($_o.formid+' #'+objid).find('.name').text();if(name==$(formObj+' [name="level_url[name]"]').val()){checkName=!1}}
if(checkName){var hasName=!1;$('#c_p_level_urls [id^="level_url_"] .name').each(function(){if($(formObj+' [name="level_url[name]"]').val()==$(this).text()){hasName=!0;return!1}});if(hasName){toastr.error('该名称已存在！');return!1}}
$.ajax({type:'POST',dataType:'json',url:$(formObj).attr('action'),data:$(formObj).serialize(),success:function(data){if(data.status==1){$('#myModal').modal('hide');$_o.level_url_op('add',data.info)}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}},relation_url_op:function(op,params){var $_o=this;params=params?params:{};var formObj=params.formObj?params.formObj:'#form_relation_url';if(op=='init'){$(formObj).bind('submit',function(){$_o.relation_url_op('add_sub');return!1});var optRelations='<optgroup label="关联页">';$('#c_p_relation_urls [id^="relation_url_"] .name').each(function(){if(params.relation_url&&$(this).text()==params.relation_url.name){return!0}
optRelations+='<option value="'+$(this).text()+'">'+$(this).text()+'</option>'});optRelations+='</optgroup>';$(formObj+' [name="relation_url[page]"]').append(optRelations);if(params.relation_url){for(var i in params.relation_url){$(formObj+' [name="relation_url['+i+']"]').val(params.relation_url[i])}}}else if(op=='add'){var relationPage=params.relation_url.page?params.relation_url.page:'内容页';if(params.objid){var eleObj=$($_o.formid+' #'+params.objid);eleObj.find('.name').html(params.relation_url.name);eleObj.find('.page').html(relationPage);eleObj.find('input[name="config[relation_urls][]"]').val(url_base64encode(JSON.stringify(params.relation_url)))}else{var html='<tr id="relation_url_'+generateUUID()+'">'+'<td><a href="javascript:;" class="name">'+params.relation_url.name+'</a></td>'+'<td class="page">'+relationPage+'</td>'+'<td>'+'<input type="hidden" name="config[relation_urls][]" value="'+url_base64encode(JSON.stringify(params.relation_url))+'" />'+'<a href="javascript:;" class="delete">删除</a>'+'&nbsp; <a href="javascript:;" class="glyphicon glyphicon-arrow-up"></a>'+'&nbsp;<a href="javascript:;" class="glyphicon glyphicon-arrow-down"></a>'+'</td>'+'</tr>';$($_o.formid+' #c_p_relation_urls').append(html)}}else if(op=='add_sub'){var objid=$(formObj+' input[name="objid"]').val();var checkName=!0;if(objid){var name=$($_o.formid+' #'+objid).find('.name').text();if(name==$(formObj+' [name="relation_url[name]"]').val()){checkName=!1}}
if(checkName){var hasName=!1;$('#c_p_relation_urls [id^="relation_url_"] .name').each(function(){if($(formObj+' [name="relation_url[name]"]').val()==$(this).text()){hasName=!0;return!1}});if(hasName){toastr.error('该名称已存在！');return!1}}
$.ajax({type:'POST',dataType:'json',url:$(formObj).attr('action'),data:$(formObj).serialize(),success:function(data){if(data.status==1){$('#myModal').modal('hide');$_o.relation_url_op('add',data.info)}else{toastr.error(data.info)}},error:function(data){toastr.error(data)}});return!1}},}